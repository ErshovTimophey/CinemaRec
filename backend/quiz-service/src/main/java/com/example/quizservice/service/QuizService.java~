package com.example.quizservice.service;

import com.example.quizservice.client.ImageStorageClient;
import com.example.quizservice.dto.QuestionDTO;
import com.example.quizservice.dto.QuizDTO;
import com.example.quizservice.dto.QuizResultDTO;
import com.example.quizservice.model.Quiz;
import com.example.quizservice.model.Question;
import com.example.quizservice.model.QuizResult;
import com.example.quizservice.repository.QuizRepository;
import com.example.quizservice.repository.QuizResultRepository;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.time.LocalDateTime;
import java.util.List;
import java.util.stream.Collectors;

@Service
public class QuizService {
    private static final Logger logger = LoggerFactory.getLogger(QuizService.class);

    @Autowired
    private QuizRepository quizRepository;

    @Autowired
    private QuizResultRepository quizResultRepository;

    @Autowired
    private ImageStorageClient imageStorageClient;

    public List<QuizDTO> getAllPublicQuizzes() {
        logger.info("Fetching all public quizzes");
        return quizRepository.findByIsPublicTrue().stream()
                .map(this::convertToDTO)
                .collect(Collectors.toList());
    }

    @Transactional
    public QuizDTO createQuiz(QuizDTO quizDTO, String creatorEmail) {
        logger.info("Creating quiz: {} by {}", quizDTO.getTitle(), creatorEmail);
        Quiz quiz = new Quiz();
        quiz.setTitle(quizDTO.getTitle());
        quiz.setDescription(quizDTO.getDescription());
        quiz.setCreatorEmail(creatorEmail);
        quiz.setPublic(quizDTO.isPublic());

        List<Question> questions = quizDTO.getQuestions().stream().map(qDTO -> {
            Question question = new Question();
            question.setText(qDTO.getText());
            question.setAnswers(qDTO.getAnswers());
            question.setCorrectAnswer(qDTO.getCorrectAnswer());
            if (qDTO.getImage() != null && !qDTO.getImage().isEmpty()) {
                String imageUrl = imageStorageClient.uploadImage(qDTO.getImage());
                question.setImageUrl(imageUrl);
                qDTO.setImageUrl(imageUrl);
                logger.info("Uploaded question image: {}", imageUrl);
            }
            return question;
        }).collect(Collectors.toList());

        quiz.setQuestions(questions);
        Quiz savedQuiz = quizRepository.save(quiz);
        logger.info("Quiz created with ID: {}", savedQuiz.getId());
        return convertToDTO(savedQuiz);
    }

    @Transactional
    public QuizResultDTO saveQuizResult(QuizResultDTO resultDTO, String userEmail) {
        logger.info("Saving quiz result for quiz ID: {}, user: {}", resultDTO.getQuizId(), userEmail);
        QuizResult result = new QuizResult();
        result.setUserEmail(userEmail);
        result.setQuizId(resultDTO.getQuizId());
        result.setScore(resultDTO.getScore());
        result.setTotalQuestions(resultDTO.getTotalQuestions());
        result.setCompletedAt(LocalDateTime.now());

        QuizResult savedResult = quizResultRepository.save(result);
        logger.info("Quiz result saved with ID: {}", savedResult.getId());
        return convertToResultDTO(savedResult);
    }

    public List<QuizResultDTO> getUserResults(String userEmail) {
        logger.info("Fetching quiz results for user: {}", userEmail);
        return quizResultRepository.findByUserEmail(userEmail).stream()
                .map(this::convertToResultDTO)
                .collect(Collectors.toList());
    }

    private QuizDTO convertToDTO(Quiz quiz) {
        QuizDTO dto = new QuizDTO();
        dto.setId(quiz.getId());
        dto.setTitle(quiz.getTitle());
        dto.setDescription(quiz.getDescription());
        dto.setCreatorEmail(quiz.getCreatorEmail());
        dto.setPublic(quiz.isPublic());
        dto.setQuestions(quiz.getQuestions().stream().map(q -> {
            QuestionDTO qDTO = new QuestionDTO();
            qDTO.setId(q.getId());
            qDTO.setText(q.getText());
            qDTO.setImageUrl(q.getImageUrl());
            qDTO.setAnswers(q.getAnswers());
            qDTO.setCorrectAnswer(q.getCorrectAnswer());
            return qDTO;
        }).collect(Collectors.toList()));
        return dto;
    }

    private QuizResultDTO convertToResultDTO(QuizResult result) {
        QuizResultDTO dto = new QuizResultDTO();
        dto.setId(result.getId());
        dto.setUserEmail(result.getUserEmail());
        dto.setQuizId(result.getQuizId());
        dto.setScore(result.getScore());
        dto.setTotalQuestions(result.getTotalQuestions());
        dto.setCompletedAt(result.getCompletedAt());
        return dto;
    }
}